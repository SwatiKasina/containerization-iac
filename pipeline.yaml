AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Pipeline to deploy VPC and EKS Cluster to Dev and QA environments.
  Creates its own S3 Bucket and IAM Roles based on the ClusterName.
  Includes Validation/Preview steps before deployment.

Parameters:
  ClusterName:
    Type: String
    Description: Project or Cluster logical name (used for naming pipeline resources)
    Default: my-eks-project
  GitHubOwner:
    Type: String
    Description: GitHub Organization or User
  GitHubRepo:
    Type: String
    Description: GitHub Repository Name
  GitHubBranch:
    Type: String
    Default: main
    Description: Branch to trigger the pipeline
  CodeStarConnectionArn:
    Type: String
    Description: ARN of the CodeStar Connection for GitHub

Resources:
  # -------------------------------------------------------------------------
  # S3 Bucket for Artifacts
  # -------------------------------------------------------------------------
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ClusterName}-pipeline-artifacts-${AWS::Region}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # -------------------------------------------------------------------------
  # IAM Roles
  # -------------------------------------------------------------------------
  
  # 1. Pipeline Role
  PipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-PipelineRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:GetBucketVersioning
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: 
                  - !GetAtt BuildProject.Arn
                  - !GetAtt ValidateProject.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn
              - Effect: Allow
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:UpdateStack
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:SetStackPolicy
                  - cloudformation:ValidateTemplate
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ClusterName}-*
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt CloudFormationServiceRole.Arn

  # 2. CodeBuild Role
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-CodeBuildRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ClusterName}-*
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              # Validation Project needs permissions to preview ChangeSets
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:CreateChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:ValidateTemplate
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ClusterName}-*

  # 3. CloudFormation Deployment Role
  CloudFormationServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-CFNDeployRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeployPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              - Effect: Allow
                Action: '*'
                Resource: '*'

  # -------------------------------------------------------------------------
  # Log Group for CodeBuild
  # -------------------------------------------------------------------------
  BuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/codebuild/${ClusterName}-Logs
      RetentionInDays: 30

  # -------------------------------------------------------------------------
  # Project 1: Build (Package Only)
  # -------------------------------------------------------------------------
  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${ClusterName}-Build
      Description: Packages source code
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Ref BuildLogGroup
          StreamName: build-log
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        Type: LINUX_CONTAINER
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            build:
              commands:
                - echo "Packaging artifacts..."
                - echo $CODEBUILD_RESOLVED_SOURCE_VERSION > commit_id.txt
          artifacts:
            files:
              - '**/*'
            name: !Sub "${ClusterName}-artifact-$CODEBUILD_RESOLVED_SOURCE_VERSION"

  # -------------------------------------------------------------------------
  # Project 2: Validate & Preview (Reusable)
  # -------------------------------------------------------------------------
  ValidateProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${ClusterName}-Validate
      Description: Runs cfn-lint and ChangeSet preview for a specific environment
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Ref BuildLogGroup
          StreamName: validate-log
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: CLUSTER_NAME
            Type: PLAINTEXT
            Value: !Ref ClusterName
          - Name: TARGET_ENV
            Type: PLAINTEXT
            Value: dev # Default, overridden by pipeline
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.x
              commands:
                - pip install cfn-lint boto3
            build:
              commands:
                - echo "Validating for Environment: $TARGET_ENV"
                
                # 1. Linting
                - echo "--- Running cfn-lint ---"
                - cfn-lint $CLUSTER_NAME/cfn/vpc.yaml
                - cfn-lint $CLUSTER_NAME/cfn/eks-cluster.yaml
                
                # 2. Preview Change Set
                - echo "--- Previewing Changes ---"
                - |
                  cat <<EOF > preview.py
                  import boto3
                  import json
                  import os
                  import time

                  cluster_name = os.environ.get('CLUSTER_NAME')
                  env = os.environ.get('TARGET_ENV')
                  
                  # Define stacks for this environment
                  stacks = [
                      {
                          'name': f"{cluster_name}-{env.capitalize()}-VPC",
                          'template': f"{cluster_name}/cfn/vpc.yaml",
                          'params_file': f"{cluster_name}/params/{env}.json"
                      },
                      {
                          'name': f"{cluster_name}-{env.capitalize()}-Cluster",
                          'template': f"{cluster_name}/cfn/eks-cluster.yaml",
                          'params_file': f"{cluster_name}/params/{env}.json"
                      }
                  ]

                  cfn = boto3.client('cloudformation')

                  def get_cli_params(params_file, cluster_name):
                      with open(params_file, 'r') as f:
                          data = json.load(f)
                      cli_params = []
                      for k, v in data.get('Parameters', {}).items():
                          cli_params.append({'ParameterKey': k, 'ParameterValue': str(v)})
                      cli_params.append({'ParameterKey': 'ClusterName', 'ParameterValue': cluster_name})
                      return cli_params

                  def preview(stack):
                      print(f"\\nPreviewing {stack['name']}...")
                      try:
                          try:
                              cfn.describe_stacks(StackName=stack['name'])
                              change_type = 'UPDATE'
                          except:
                              change_type = 'CREATE'
                              print(f"Stack does not exist. Action: {change_type}")

                          params = get_cli_params(stack['params_file'], cluster_name)
                          with open(stack['template'], 'r') as f:
                              template_body = f.read()

                          cs_name = f"Prev-{int(time.time())}"
                          
                          cfn.create_change_set(
                              StackName=stack['name'],
                              TemplateBody=template_body,
                              Parameters=params,
                              ChangeSetName=cs_name,
                              ChangeSetType=change_type,
                              Capabilities=['CAPABILITY_NAMED_IAM']
                          )
                          
                          waiter = cfn.get_waiter('change_set_create_complete')
                          waiter.wait(StackName=stack['name'], ChangeSetName=cs_name)
                          
                          response = cfn.describe_change_set(StackName=stack['name'], ChangeSetName=cs_name)
                          changes = response.get('Changes', [])
                          
                          if not changes:
                              print("No changes.")
                          else:
                              print(f"{'Action':<15} {'Logical ID':<30} {'Type':<30} {'Replacement'}")
                              print("-" * 90)
                              for c in changes:
                                  rc = c['ResourceChange']
                                  print(f"{rc['Action']:<15} {rc['LogicalResourceId']:<30} {rc['ResourceType']:<30} {rc.get('Replacement', '')}")
                          
                          cfn.delete_change_set(StackName=stack['name'], ChangeSetName=cs_name)

                      except Exception as e:
                          print(f"Error: {str(e)}")
                          # We do not fail the build for preview errors to avoid blocking deployment on permissions issues, 
                          # but you can uncomment the next line to enforce strict previews.
                          # exit(1) 

                  for s in stacks:
                      preview(s)
                  EOF
                - python3 preview.py

  # -------------------------------------------------------------------------
  # CodePipeline
  # -------------------------------------------------------------------------
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${ClusterName}-Pipeline
      RoleArn: !GetAtt PipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Stages:
        # 1. Source
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Sub ${GitHubOwner}/${GitHubRepo}
                BranchName: !Ref GitHubBranch
                OutputArtifactFormat: CODEBUILD_CLONE_REF
              OutputArtifacts:
                - Name: SourceArtifact

        # 2. Build (Just Package)
        - Name: Build
          Actions:
            - Name: Package
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref BuildProject
              InputArtifacts:
                - Name: SourceArtifact
              OutputArtifacts:
                - Name: BuildArtifact

        # 3. Deploy Dev (Validate -> VPC -> Cluster)
        - Name: DeployDev
          Actions:
            - Name: ValidateDev
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref ValidateProject
                EnvironmentVariables: '[{"name":"TARGET_ENV","value":"dev"}]'
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 1
            
            - Name: Dev-VPC
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-Dev-VPC
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/vpc.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/dev.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 2

            - Name: Dev-Cluster
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-Dev-Cluster
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/eks-cluster.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/dev.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 3

        # 4. Approval
        - Name: Approval
          Actions:
            - Name: ApprovePromoteToQA
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: '1'
              RunOrder: 1

        # 5. Deploy QA (Validate -> VPC -> Cluster)
        - Name: DeployQA
          Actions:
            - Name: ValidateQA
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref ValidateProject
                EnvironmentVariables: '[{"name":"TARGET_ENV","value":"qa"}]'
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 1

            - Name: QA-VPC
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-QA-VPC
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/vpc.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/qa.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 2

            - Name: QA-Cluster
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-QA-Cluster
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/eks-cluster.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/qa.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 3

Outputs:
  PipelineUrl:
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${Pipeline}/view
    Description: URL of the created pipeline
  ArtifactBucketName:
    Value: !Ref ArtifactBucket
    Description: Name of the created S3 artifact bucket
