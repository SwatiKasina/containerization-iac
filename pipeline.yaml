AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Pipeline to deploy VPC and EKS Cluster to Dev and QA environments.
  Creates its own S3 Bucket, KMS Key, and IAM Roles based on the ClusterName.
  Includes Validation/Preview steps before deployment.

Parameters:
  ClusterName:
    Type: String
    Description: Project or Cluster logical name (used for naming pipeline resources)
    Default: my-eks-project
  GitHubOwner:
    Type: String
    Description: GitHub Organization or User
  GitHubRepo:
    Type: String
    Description: GitHub Repository Name
  GitHubBranch:
    Type: String
    Default: main
    Description: Branch to trigger the pipeline
  CodeStarConnectionArn:
    Type: String
    Description: ARN of the CodeStar Connection for GitHub

Resources:
  # -------------------------------------------------------------------------
  # KMS Key for Artifact Encryption
  # -------------------------------------------------------------------------
  ArtifactKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub KMS Key for ${ClusterName} Pipeline Artifacts
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Id: !Sub ${ClusterName}-KeyPolicy
        Statement:
          # Allow Root User (Admin) to manage key
          # This delegates access control to IAM policies, avoiding circular dependencies with the Service Roles.
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'

  ArtifactKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${ClusterName}-pipeline-key
      TargetKeyId: !Ref ArtifactKey

  # -------------------------------------------------------------------------
  # S3 Bucket for Artifacts
  # -------------------------------------------------------------------------
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ClusterName}-pipeline-artifacts-${AWS::Region}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref ArtifactKey

  # -------------------------------------------------------------------------
  # IAM Roles
  # -------------------------------------------------------------------------
  
  # 1. Pipeline Role
  PipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-PipelineRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:GetBucketVersioning
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: 
                  - !GetAtt BuildProject.Arn
                  - !GetAtt ValidateProject.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn
              - Effect: Allow
                Action:
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:UpdateStack
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:SetStackPolicy
                  - cloudformation:ValidateTemplate
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ClusterName}-*
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt CloudFormationServiceRole.Arn
              # KMS Access
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                  - kms:Encrypt
                Resource: !GetAtt ArtifactKey.Arn

  # 2. CodeBuild Role
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-CodeBuildRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ClusterName}-*
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:GetBucketLocation
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              # Validation Project needs permissions to preview ChangeSets
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:CreateChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:ValidateTemplate
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ClusterName}-*
              # KMS Access
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                  - kms:Encrypt
                Resource: !GetAtt ArtifactKey.Arn
              # Allow CodeBuild to use the CodeStar connection when using CODEBUILD_CLONE_REF
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn

  # 3. CloudFormation Deployment Role
  CloudFormationServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ClusterName}-CFNDeployRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeployPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: 
                  - !GetAtt ArtifactBucket.Arn
                  - !Sub ${ArtifactBucket.Arn}/*
              - Effect: Allow
                Action: '*'
                Resource: '*'
              # KMS Access (to decrypt template)
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt ArtifactKey.Arn

  # -------------------------------------------------------------------------
  # Log Group for CodeBuild
  # -------------------------------------------------------------------------
  BuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/codebuild/${ClusterName}-Logs
      RetentionInDays: 30

  # -------------------------------------------------------------------------
  # Project 1: Build (Package Only)
  # -------------------------------------------------------------------------
  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${ClusterName}-Build
      Description: Packages source code
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Ref BuildLogGroup
          StreamName: build-log
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        Type: LINUX_CONTAINER
      Source:
        Type: CODEPIPELINE
        BuildSpec: buildspec.yml

  # -------------------------------------------------------------------------
  # Project 2: Validate & Preview (Reusable)
  # -------------------------------------------------------------------------
  ValidateProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${ClusterName}-Validate
      Description: Runs cfn-lint and ChangeSet preview for a specific environment
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Ref BuildLogGroup
          StreamName: validate-log
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: CLUSTER_NAME
            Type: PLAINTEXT
            Value: !Ref ClusterName
          - Name: TARGET_ENV
            Type: PLAINTEXT
            Value: dev # Default, overridden by pipeline
      Source:
        Type: CODEPIPELINE
        BuildSpec: buildspec-validate.yml

  # -------------------------------------------------------------------------
  # CodePipeline
  # -------------------------------------------------------------------------
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${ClusterName}-Pipeline
      RoleArn: !GetAtt PipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
        EncryptionKey:
          Id: !Ref ArtifactKey
          Type: KMS
      Stages:
        # 1. Source
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Sub ${GitHubOwner}/${GitHubRepo}
                BranchName: !Ref GitHubBranch
                OutputArtifactFormat: CODEBUILD_CLONE_REF
              OutputArtifacts:
                - Name: SourceArtifact

        # 2. Build (Just Package)
        - Name: Build
          Actions:
            - Name: Package
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref BuildProject
              InputArtifacts:
                - Name: SourceArtifact
              OutputArtifacts:
                - Name: BuildArtifact

        # 3. Deploy Dev (Validate -> VPC -> Cluster)
        - Name: DeployDev
          Actions:
            - Name: ValidateDev
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref ValidateProject
                EnvironmentVariables: '[{"name":"TARGET_ENV","value":"dev"}]'
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 1
            
            - Name: Dev-VPC
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-Dev-VPC
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/vpc.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/dev.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 2

            - Name: Dev-Cluster
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-Dev-Cluster
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/eks-cluster.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/dev.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 3

        # 4. Approval
        - Name: Approval
          Actions:
            - Name: ApprovePromoteToQA
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: '1'
              RunOrder: 1

        # 5. Deploy QA (Validate -> VPC -> Cluster)
        - Name: DeployQA
          Actions:
            - Name: ValidateQA
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref ValidateProject
                EnvironmentVariables: '[{"name":"TARGET_ENV","value":"qa"}]'
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 1

            - Name: QA-VPC
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-QA-VPC
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/vpc.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/qa.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 2

            - Name: QA-Cluster
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: !Sub ${ClusterName}-QA-Cluster
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: !GetAtt CloudFormationServiceRole.Arn
                TemplatePath: !Sub BuildArtifact::${ClusterName}/cfn/eks-cluster.yaml
                TemplateConfiguration: !Sub BuildArtifact::${ClusterName}/params/qa.json
                ParameterOverrides: !Sub |
                  {
                    "ClusterName": "${ClusterName}"
                  }
              InputArtifacts:
                - Name: BuildArtifact
              RunOrder: 3

Outputs:
  PipelineUrl:
    Value: !Sub https://${AWS::Region}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${Pipeline}/view
    Description: URL of the created pipeline
  ArtifactBucketName:
    Value: !Ref ArtifactBucket
    Description: Name of the created S3 artifact bucket
